<?xml version="1.0" encoding="UTF-8"?>
<odoo>
  <template id="university_degree_report_template">
    <t t-call="web.html_container">
      <t t-foreach="docs" t-as="o">

        <!-- Styles (consider moving to a report asset bundle) -->
        <style>
          html, body { margin:0!important; padding:0!important; background:#e3e2d8; font-size:13px; }
          main { margin:0; padding:0; }
          .certificate-wrapper { width:100%; background:#e3e2d8; padding:20px; box-sizing:border-box; position:relative; }
          .separator, .separator-bottom { text-align:center; }
          .separator img, .separator-bottom img { width:900px; height:180px; }
          .certificate-header { margin-top:-60px; margin-bottom:10px; text-align:center; }
          .company-logo { width:90px; height:auto; display:block; margin:10px auto 0; }
          .subtitle { text-align:center; font-size:14px; margin:6px 0 16px; }
          .info-table, .grades-table, .gpa-summary-table { width:100%; border-collapse:collapse; font-size:13px; background:#e3e2d8; margin-top:16px; }
          .info-table td, .info-table th, .grades-table td, .grades-table th, .gpa-summary-table td, .gpa-summary-table th { border:1px solid #000; padding:4px 6px; text-align:left; }
          .info-table th { font-weight:bold; width:14%; }
          .grades-table th { background:#a02020; color:#fff; font-weight:bold; text-align:center; }
          .grades-table td { text-align:center; }
          .semester-title { font-weight:bold; text-align:center; font-size:16px; padding:8px; }
          .year-title { text-align:center; font-size:18px; font-weight:bold; margin-top:8px; }
          .gpa-summary-table { width:50%; font-family:Arial, sans-serif; }
          .gpa-summary-table th { background:#f2f2f2; font-weight:normal; text-align:center; }
          .gpa-summary-table td { text-align:center; }
          .grade-range-table { width:50%; margin-top:20px; border-collapse:collapse; font-family:Arial, sans-serif; font-size:13px; }
          .grade-range-table th, .grade-range-table td { border:1px solid #000; padding:4px; text-align:center; }
          .grade-range-table th { background:#f2f2f2; font-weight:normal; }
          .sign-row { width:100%; margin-top:30px; text-align:center; font-family:Arial, sans-serif; border-collapse:collapse; }
          .sign-row td { background:none; border:none; vertical-align:top; padding:10px 0; }
          .sign-seal { position:relative; text-align:center; }
          .seal-img { position:absolute; top:35px; left:50%; transform:translateX(-50%); height:180px; opacity:.35; mix-blend-mode:multiply; z-index:2; }
          .sign-img { height:50px; margin:5px 0; border:none; background:none; position:relative; z-index:1; }
          .page-break { page-break-after:always; }
        </style>

        <!-- Absolute base so wkhtmltopdf can fetch assets correctly -->
        <t t-set="ABS"
           t-value="o.env['ir.config_parameter'].sudo().get_param('web.external.url')
                    or o.env['ir.config_parameter'].sudo().get_param('web.base.url')"/>

        <!-- Load student results -->
        <t t-set="results"
           t-value="o.env['university.degree.result'].sudo().search(
                     [('student_id', '=', o.student_id.id)],
                     order='semester_date asc, id asc'
                   )"/>

        <t t-if="results">

          <!-- Unique years -->
          <t t-set="years" t-value="[]"/>
          <t t-set="last_year" t-value="None"/>
          <t t-foreach="results" t-as="r">
            <t t-set="yr" t-value="(r.semester_date and str(r.semester_date.year)) or 'N/A'"/>
            <t t-if="yr != last_year">
              <t t-set="years" t-value="years + [yr]"/>
              <t t-set="last_year" t-value="yr"/>
            </t>
          </t>

          <t t-set="ycount" t-value="0"/>
          <t t-foreach="years" t-as="year">
            <main>
              <div class="certificate-wrapper">

                <!-- Top separator -->
                <div class="separator">
                  <img t-att-src="ABS + '/university_degree/static/description/separator.png'" alt="Separator"/>
                </div>

                <!-- Header -->
                <div class="certificate-header">
                  <div style="font-size:24px; font-weight:400; margin-bottom:4px;">United World Education Academy</div>
                  <div style="font-size:28px; font-weight:700; margin-bottom:10px;">ACADEMIC CERTIFICATE</div>
                  <img t-att-src="ABS + '/university_degree/static/description/logo7.png'" class="company-logo" alt="Logo"/>
                </div>

                <!-- Student course -->
                <t t-set="stu_no" t-value="(o.student_id and o.student_id.student_no) or False"/>
                <t t-set="student"
                   t-value="stu_no and o.env['university.student'].sudo().search([('student_no','=', stu_no)], limit=1) or False"/>
                <t t-set="course_name"
                   t-value="student and (('course_id' in student._fields and student.course_id and student.course_id.name) or
                                         ('course_name' in student._fields and student.course_name)) or 'Business Administration'"/>

                <div class="subtitle">
                  Prepared for the UWA <t t-esc="course_name"/> Transfer Program provided by UWE
                </div>

                <!-- Student info -->
                <table class="info-table">
                  <tr>
                    <th>Student Name</th>
                    <td>
                      <t t-if="o.student_id and o.student_id.name"><t t-esc="o.student_id.name"/></t>
                      <t t-if="o.student_id and o.student_id.middle_name"> <t t-esc="o.student_id.middle_name"/></t>
                      <t t-if="o.student_id and o.student_id.last_name"> <t t-esc="o.student_id.last_name"/></t>
                      <t t-if="not o.student_id or not o.student_id.name">N/A</t>
                    </td>
                    <th>Student ID</th>
                    <td><t t-esc="(o.student_id and o.student_id.student_no) or 'N/A'"/></td>
                    <th>Date of Issue</th>
                    <td>
                      <t t-if="'issue_date' in o._fields and o.issue_date">
                        <span t-field="o.issue_date" t-options='{"widget":"date"}'/>
                      </t>
                      <t t-elif="o.create_date">
                        <span t-field="o.create_date" t-options='{"widget":"datetime"}'/>
                      </t>
                      <t t-else="">N/A</t>
                    </td>
                  </tr>
                </table>

                <!-- (… keep your semesters, GPA tables, and grade scale unchanged …) -->

                <!-- Signatures -->
                <table class="sign-row">
                  <tr>
                    <td>
                      <strong>Registrar</strong><br/>
                      <img t-att-src="ABS + '/university_degree/static/description/mUstafa.png'" class="sign-img" alt="Registrar Signature"/><br/>
                      <hr style="width:60%; border:1px solid #000;"/>
                      Dr. Mostafa Eltemamy
                    </td>
                    <td>
                      <strong>Academic Coordinator</strong><br/>
                      <img t-att-src="ABS + '/university_degree/static/description/signature_george2.png'" class="sign-img" alt="Academic Coordinator Signature"/><br/>
                      <hr style="width:60%; border:1px solid #000;"/>
                      Dr. George Alkhouri
                    </td>
                    <td class="sign-seal">
                      <strong>University Dean</strong><br/>
                      <img t-att-src="ABS + '/university_degree/static/description/seal3.png'" class="seal-img" alt="University Seal"/>
                      <img t-att-src="ABS + '/university_degree/static/description/mustafa.png'" class="sign-img" alt="University Dean Signature"/><br/>
                      <hr style="width:60%; border:1px solid #000;"/>
                      Dr. Sahel Alhabashneh
                    </td>
                  </tr>
                </table>

                <!-- Bottom separator -->
                <div class="separator-bottom" style="margin-top:10px;">
                  <img t-att-src="ABS + '/university_degree/static/description/separator.png'" alt="Bottom Separator"/>
                </div>

              </div>
            </main>

            <t t-set="ycount" t-value="ycount + 1"/>
            <t t-if="ycount &lt; len(years)"><div class="page-break"></div></t>
          </t>
        </t>
        <t t-else="">
          <main><div class="certificate-wrapper"><div class="semester-title">No degree results available for this student.</div></div></main>
        </t>

      </t>
    </t>
  </template>
</odoo>
